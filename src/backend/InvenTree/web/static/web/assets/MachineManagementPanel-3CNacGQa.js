import{j as e,cJ as re,r as p,G as h,B as j,bS as B,A as w,i as t,bO as L,cN as G,F as Q,n as ne,aB as le,S as b,bd as W,bW as a,c8 as I,bT as U,cF as ae,ei as z,eb as O,bU as R,d as de,T as S,bK as X,bx as D}from"./vendor-c9tu_e1b.js";import{A as y,e as M,a as oe}from"./index-C-YqHYR0.js";import{a as $,S as C}from"./ThemeContext-CVPHi9Q7.js";import{o as ce,b as xe,A as ue,u as je,a as pe,h as he}from"./UseForm-21BEg7Md.js";import{Y as J}from"./YesNoButton-BdKeJbQO.js";import{u as V,I as K,O as _e,E as me,D as fe}from"./InvenTreeTable-_nPJoCLK.js";import{I as x}from"./InfoItem-6rOwq8Um.js";import{D as Y,a as Z}from"./DetailDrawer-BVL1Qt62.js";import{M as H}from"./SettingList-Bx7uAi1U.js";import{u as P}from"./DesktopAppView-Bg1vO8uy.js";import{B as q,D as ee}from"./ColumnRenderers-6-W27ey5.js";import"./ActionButton-Cn3lAMG1.js";import"./index-D1sX3jYA.js";import"./QRCode-4MaRh6JQ.js";import"./browser-oJrDmCBJ.js";import"./formatters-1-K9MQML.js";function E(){return e.jsx(re,{size:18,color:"red"})}function se({machine:n}){const d={marginLeft:"4px"};if(!n.active)return e.jsx(G,{style:d,color:"gray",children:e.jsx(Q,{})});let l="green";n.machine_errors.length>0||!n.is_driver_available||n.status>=300?l="red":n.status>=200&&(l="orange");const s=n.initialized&&n.status>0&&n.status<300;return e.jsx(G,{processing:s,style:d,color:l,children:e.jsx(Q,{})})}function T({includeTypes:n=!0,includeDrivers:d=!0}={}){const l=P(),{data:o,isFetching:s,refetch:i}=L({enabled:n,queryKey:["machine-types"],queryFn:()=>l.get(M(y.machine_types_list)).then(c=>c.data),staleTime:10*1e3}),{data:f,isFetching:_,refetch:u}=L({enabled:d,queryKey:["machine-drivers"],queryFn:()=>l.get(M(y.machine_driver_list)).then(c=>c.data),staleTime:10*1e3}),m=p.useCallback(()=>{i(),u()},[u,i]);return{machineTypes:o,machineDrivers:f,isFetching:s||_,refresh:m}}function ge({machinePk:n,refreshTable:d}){const l=P(),o=$(),{data:s,refetch:i,isFetching:f}=L({enabled:!0,queryKey:["machine-detail",n],queryFn:()=>l.get(M(y.machine_list,n)).then(F=>F.data)}),{machineTypes:_,machineDrivers:u,isFetching:m}=T(),c=f||m,g=p.useMemo(()=>_&&s?_.find(F=>F.slug===s.machine_type):void 0,[s==null?void 0:s.machine_type,_]),A=p.useMemo(()=>u&&s?u.find(F=>F.slug===s.driver):void 0,[s==null?void 0:s.driver,u]),r=p.useCallback(()=>{i(),d()},[i,d]),v=p.useCallback(F=>{l.post(M(y.machine_restart,void 0,{machine:F})).then(()=>{r(),ne.show({message:t._({id:"8hvWaA"}),color:"green",icon:e.jsx(le,{size:"1rem"})})})},[r]),k=je({title:t._({id:"RBquff"}),url:y.machine_list,pk:n,fields:p.useMemo(()=>({name:{},active:{}}),[]),onClose:()=>r()}),N=pe({title:t._({id:"5ihjEH"}),successMessage:t._({id:"ZbXCol"}),url:y.machine_list,pk:n,preFormContent:e.jsx(j,{children:t._({id:"Y9eJUJ",values:{0:(s==null?void 0:s.name)??"unknown"}})}),onFormSuccess:()=>{d(),o(-1)}});return e.jsx(e.Fragment,{children:e.jsxs(b,{gap:"xs",children:[k.modal,N.modal,e.jsxs(h,{justify:"space-between",children:[e.jsxs(h,{children:[s&&e.jsx(se,{machine:s}),e.jsx(C,{size:"md",children:(s==null?void 0:s.name)??t._({id:"HCk1Xx"})})]}),e.jsxs(h,{children:[(s==null?void 0:s.restart_required)&&e.jsx(B,{color:"red",children:e.jsx(w,{id:"dKwnjv"})}),e.jsx(_e,{tooltip:t._({id:"72f9dQ"}),actions:[me({tooltip:t._({id:"RBquff"}),onClick:k.open}),fe({tooltip:t._({id:"5ihjEH"}),onClick:N.open}),{icon:e.jsx(W,{}),name:t._({id:"6z9W13"}),tooltip:t._({id:"Plnldt"})+(s!=null&&s.restart_required?` (${t._({id:"kbLjlB"})})`:""),indicator:s!=null&&s.restart_required?{color:"red"}:void 0,onClick:()=>s&&v(s==null?void 0:s.pk)}]})]})]}),e.jsxs(a,{multiple:!0,defaultValue:["machine-info","machine-settings","driver-settings"],children:[e.jsxs(a.Item,{value:"machine-info",children:[e.jsx(a.Control,{children:e.jsx(C,{size:"lg",children:t._({id:"gz3Ont"})})}),e.jsx(a.Panel,{children:e.jsx(I,{withBorder:!0,children:e.jsx(b,{gap:"md",children:e.jsxs(b,{pos:"relative",gap:"xs",children:[e.jsx(U,{visible:c,overlayProps:{opacity:0}}),e.jsx(x,{name:t._({id:"pwL+bm"}),children:e.jsxs(h,{gap:"xs",children:[g?e.jsx(Z,{to:`../type-${s==null?void 0:s.machine_type}`,text:g.name}):e.jsx(j,{children:s==null?void 0:s.machine_type}),s&&!g&&e.jsx(E,{})]})}),e.jsx(x,{name:t._({id:"3ADt1I"}),children:e.jsxs(h,{gap:"xs",children:[A?e.jsx(Z,{to:`../driver-${s==null?void 0:s.driver}`,text:A.name}):e.jsx(j,{children:s==null?void 0:s.driver}),!(s!=null&&s.is_driver_available)&&e.jsx(E,{})]})}),e.jsx(x,{name:t._({id:"nsu9Un"}),children:e.jsx(J,{value:(s==null?void 0:s.initialized)||!1})}),e.jsx(x,{name:t._({id:"F6pfE9"}),children:e.jsx(J,{value:(s==null?void 0:s.active)||!1})}),e.jsx(x,{name:t._({id:"uAQUqI"}),children:e.jsxs(ae,{direction:"column",children:[(s==null?void 0:s.status)===-1?e.jsx(j,{fz:"xs",children:"No status"}):he({status:`${(s==null?void 0:s.status)||-1}`,type:`MachineStatus__${s==null?void 0:s.status_model}`}),e.jsx(j,{fz:"sm",children:s==null?void 0:s.status_text})]})}),e.jsxs(h,{justify:"space-between",gap:"xs",children:[e.jsxs(j,{fz:"sm",fw:700,children:[e.jsx(w,{id:"UirGxE"}),":"]}),s&&(s==null?void 0:s.machine_errors.length)>0?e.jsx(B,{color:"red",style:{marginLeft:"10px"},children:s==null?void 0:s.machine_errors.length}):e.jsx(j,{fz:"xs",children:e.jsx(w,{id:"hIOaIF"})}),e.jsx(z,{w:"100%",children:s==null?void 0:s.machine_errors.map((F,te)=>e.jsx(z.Item,{children:e.jsx(O,{children:F})},te))})]})]})})})})]}),(s==null?void 0:s.is_driver_available)&&e.jsxs(a.Item,{value:"machine-settings",children:[e.jsx(a.Control,{children:e.jsx(C,{size:"lg",children:t._({id:"m57e2B"})})}),e.jsx(a.Panel,{children:e.jsx(I,{withBorder:!0,children:e.jsx(H,{machinePk:n,configType:"M",onChange:r})})})]}),(s==null?void 0:s.is_driver_available)&&e.jsxs(a.Item,{value:"driver-settings",children:[e.jsx(a.Control,{children:e.jsx(C,{size:"lg",children:t._({id:"fWJCep"})})}),e.jsx(a.Panel,{children:e.jsx(I,{withBorder:!0,children:e.jsx(H,{machinePk:n,configType:"D",onChange:r})})})]})]})]})})}function ie({props:n,renderMachineDrawer:d=!0,createProps:l}){const{machineTypes:o,machineDrivers:s}=T(),i=V("machine"),f=$(),_=p.useMemo(()=>[{accessor:"name",sortable:!0,render:r=>e.jsxs(h,{justify:"left",wrap:"nowrap",children:[e.jsx(se,{machine:r}),e.jsx(j,{children:r.name}),r.restart_required&&e.jsx(B,{color:"red",children:e.jsx(w,{id:"dKwnjv"})})]})},{accessor:"machine_type",sortable:!0,render:r=>{const v=o==null?void 0:o.find(k=>k.slug===r.machine_type);return e.jsxs(h,{gap:"xs",children:[e.jsx(j,{children:v?v.name:r.machine_type}),o&&!v&&e.jsx(E,{})]})}},{accessor:"driver",sortable:!0,render:r=>{const v=s==null?void 0:s.find(k=>k.slug===r.driver);return e.jsxs(h,{gap:"xs",children:[e.jsx(j,{children:v?v.name:r.driver}),!r.is_driver_available&&e.jsx(E,{})]})}},q({accessor:"initialized"}),q({accessor:"active"}),{accessor:"status",sortable:!1,render:r=>{const v=ce(`MachineStatus__${r.status_model}`);if(v&&r.status!==-1)return v(r)}}],[o]),[u,m]=p.useState(null),c=p.useMemo(()=>s?s.filter(r=>r.machine_type===u).map(r=>({value:r.slug,display_name:r.name})):[],[s,u]),g=xe({title:t._({id:"V0xlx2"}),url:y.machine_list,fields:{name:{},machine_type:{hidden:!!(l!=null&&l.machine_type),...l!=null&&l.machine_type?{value:l.machine_type}:{},field_type:"choice",choices:o?o.map(r=>({value:r.slug,display_name:r.name})):[],onValueChange:r=>m(r)},driver:{hidden:!!(l!=null&&l.driver),...l!=null&&l.driver?{value:l.driver}:{},field_type:"choice",disabled:!u,choices:c},active:{}},onFormSuccess:r=>{i.refreshTable(),f(d?`machine-${r.pk}/`:`../machine-${r.pk}/`)},onClose:()=>{m(null)}}),A=p.useMemo(()=>[e.jsx(ue,{tooltip:t._({id:"kZ/tbb"}),onClick:()=>{m(null),g.open()}},"add-machine")],[g.open]);return e.jsxs(e.Fragment,{children:[g.modal,d&&e.jsx(Y,{title:t._({id:"YDOU4Q"}),size:"xl",renderContent:r=>!r||!r.startsWith("machine-")?!1:e.jsx(ge,{machinePk:r.replace("machine-",""),refreshTable:i.refreshTable})}),e.jsx(K,{url:M(y.machine_list),tableState:i,columns:_,props:{...n,enableDownload:!1,onRowClick:r=>f(d?`machine-${r.pk}/`:`../machine-${r.pk}/`),tableActions:A,params:{...n.params},tableFilters:[{name:"active",label:t._({id:"F6pfE9"}),type:"boolean"},{name:"machine_type",label:t._({id:"pwL+bm"}),type:"choice",choiceFunction:()=>o?o.map(r=>({value:r.slug,label:r.name})):[]},{name:"driver",label:t._({id:"6ccUsd"}),type:"choice",choiceFunction:()=>s?s.map(r=>({value:r.slug,label:r.name})):[]}]}})]})}function ve({machineTypeSlug:n}){var _,u,m;const d=$(),{machineTypes:l,isFetching:o}=T({includeDrivers:!1}),s=p.useMemo(()=>l==null?void 0:l.find(c=>c.slug===n),[l,n]),i=V("machineDrivers"),f=p.useMemo(()=>[{accessor:"name",title:t._({id:"6YtxFj"})},ee({}),q({accessor:"is_builtin",title:t._({id:"argeGI"})})],[]);return e.jsx(e.Fragment,{children:e.jsxs(b,{children:[e.jsx(h,{wrap:"nowrap",children:e.jsx(C,{size:"md",children:s?s.name:n})}),!s&&e.jsx(R,{color:"red",title:t._({id:"pAtylB"}),icon:e.jsx(de,{}),children:e.jsx(j,{children:t._({id:"FW2Ygg"})})}),e.jsxs(a,{multiple:!0,defaultValue:["machine-type-info","machine-drivers"],children:[e.jsxs(a.Item,{value:"machine-type-info",children:[e.jsx(a.Control,{children:e.jsx(C,{size:"lg",children:t._({id:"RRr8s4"})})}),e.jsx(a.Panel,{children:e.jsx(I,{withBorder:!0,children:e.jsxs(b,{pos:"relative",gap:"xs",children:[e.jsx(U,{visible:o,overlayProps:{opacity:0}}),e.jsx(x,{name:t._({id:"6YtxFj"}),value:s==null?void 0:s.name,type:"text"}),e.jsx(x,{name:t._({id:"L85WcV"}),value:s==null?void 0:s.slug,type:"text"}),e.jsx(x,{name:t._({id:"Nu4oKW"}),value:s==null?void 0:s.description,type:"text"}),!(s!=null&&s.is_builtin)&&e.jsx(x,{name:t._({id:"umAemZ"}),value:(_=s==null?void 0:s.provider_plugin)==null?void 0:_.name,type:"text",link:((u=s==null?void 0:s.provider_plugin)==null?void 0:u.pk)!==null?`../../plugin/${(m=s==null?void 0:s.provider_plugin)==null?void 0:m.pk}/`:void 0,detailDrawerLink:!0}),e.jsx(x,{name:t._({id:"jfVQG5"}),value:s==null?void 0:s.provider_file,type:"code"}),e.jsx(x,{name:t._({id:"++LBSt"}),value:s==null?void 0:s.is_builtin,type:"boolean"})]})})})]}),e.jsxs(a.Item,{value:"machine-drivers",children:[e.jsx(a.Control,{children:e.jsx(C,{size:"lg",children:t._({id:"qTGFbM"})})}),e.jsx(a.Panel,{children:e.jsx(I,{withBorder:!0,children:e.jsx(K,{url:M(y.machine_driver_list),tableState:i,columns:f,props:{dataFormatter:c=>c.filter(g=>g.machine_type===n),enableDownload:!1,enableSearch:!1,onRowClick:c=>d(`../driver-${c.slug}/`)}})})})]})]})]})})}function ye({machineDriverSlug:n}){var _,u,m;const{machineDrivers:d,machineTypes:l,refresh:o,isFetching:s}=T(),i=p.useMemo(()=>d==null?void 0:d.find(c=>c.slug===n),[d,n]),f=p.useMemo(()=>l==null?void 0:l.find(c=>c.slug===(i==null?void 0:i.machine_type)),[d,l]);return e.jsxs(b,{children:[e.jsx(h,{justify:"center",children:e.jsx(S,{order:4,children:i?i.name:n})}),!i&&e.jsx(j,{style:{fontStyle:"italic"},children:e.jsx(w,{id:"p6inm0"})}),e.jsx(I,{withBorder:!0,children:e.jsxs(b,{gap:"md",children:[e.jsxs(h,{justify:"space-between",children:[e.jsx(S,{order:4,children:e.jsx(w,{id:"Dm7Jy5"})}),e.jsx(X,{variant:"outline",onClick:()=>o(),children:e.jsx(W,{})})]}),e.jsxs(b,{pos:"relative",gap:"xs",children:[e.jsx(U,{visible:s,overlayProps:{opacity:0}}),e.jsx(x,{name:t._({id:"6YtxFj"}),value:i==null?void 0:i.name,type:"text"}),e.jsx(x,{name:t._({id:"L85WcV"}),value:i==null?void 0:i.slug,type:"text"}),e.jsx(x,{name:t._({id:"Nu4oKW"}),value:i==null?void 0:i.description,type:"text"}),e.jsx(x,{name:t._({id:"I+nMNp"}),value:f?f.name:i==null?void 0:i.machine_type,type:"text",link:f?`../type-${i==null?void 0:i.machine_type}`:void 0,detailDrawerLink:!0}),!(i!=null&&i.is_builtin)&&e.jsx(x,{name:t._({id:"umAemZ"}),value:(_=i==null?void 0:i.provider_plugin)==null?void 0:_.name,type:"text",link:((u=i==null?void 0:i.provider_plugin)==null?void 0:u.pk)!==null?`../../plugin/${(m=i==null?void 0:i.provider_plugin)==null?void 0:m.pk}/`:void 0,detailDrawerLink:!0}),e.jsx(x,{name:t._({id:"jfVQG5"}),value:i==null?void 0:i.provider_file,type:"code"}),e.jsx(x,{name:t._({id:"++LBSt"}),value:i==null?void 0:i.is_builtin,type:"boolean"}),e.jsxs(h,{justify:"space-between",gap:"xs",children:[e.jsxs(j,{fz:"sm",fw:700,children:[e.jsx(w,{id:"UirGxE"}),":"]}),i&&(i==null?void 0:i.driver_errors.length)>0?e.jsx(B,{color:"red",style:{marginLeft:"10px"},children:i.driver_errors.length}):e.jsx(j,{fz:"xs",children:e.jsx(w,{id:"hIOaIF"})}),e.jsx(z,{w:"100%",children:i==null?void 0:i.driver_errors.map((c,g)=>e.jsx(z.Item,{children:e.jsx(O,{children:c})},`${g}-${c}`))})]})]})]})}),e.jsx(I,{withBorder:!0,children:e.jsxs(b,{gap:"md",children:[e.jsx(S,{order:4,children:e.jsx(w,{id:"Qf5DYN"})}),e.jsx(ie,{props:{params:{driver:n}},renderMachineDrawer:!1,createProps:{machine_type:i==null?void 0:i.machine_type,driver:n}})]})})]})}function be({props:n}){const d=V("machineTypes"),l=$(),o=p.useMemo(()=>[{accessor:"name",title:t._({id:"6YtxFj"})},ee({}),q({accessor:"is_builtin",title:t._({id:"eBtH/D"})})],[]);return e.jsxs(e.Fragment,{children:[e.jsx(Y,{title:t._({id:"qRwuAd"}),size:"xl",renderContent:s=>!s||!s.startsWith("type-")?!1:e.jsx(ve,{machineTypeSlug:s.replace("type-","")})}),e.jsx(Y,{title:t._({id:"RYeia3"}),size:"xl",renderContent:s=>!s||!s.startsWith("driver-")?!1:e.jsx(ye,{machineDriverSlug:s.replace("driver-","")})}),e.jsx(K,{url:M(y.machine_types_list),tableState:d,columns:o,props:{...n,enableDownload:!1,enableSearch:!1,onRowClick:s=>l(`type-${s.slug}/`),params:{...n.params}}})]})}function Ye(){var o;const{data:n,refetch:d}=L({queryKey:["machine-registry-status"],queryFn:()=>oe.get(M(y.machine_registry_status)).then(s=>s.data),staleTime:1e4}),l=p.useMemo(()=>(n==null?void 0:n.registry_errors)&&n.registry_errors.length>0,[n]);return e.jsxs(a,{multiple:!0,defaultValue:["machinelist","machinetypes"],children:[e.jsxs(a.Item,{value:"machinelist",children:[e.jsx(a.Control,{children:e.jsx(C,{size:"lg",children:t._({id:"Qf5DYN"})})}),e.jsx(a.Panel,{children:e.jsx(ie,{props:{}})})]}),e.jsxs(a.Item,{value:"machinetypes",children:[e.jsx(a.Control,{children:e.jsx(C,{size:"lg",children:t._({id:"XyzprV"})})}),e.jsx(a.Panel,{children:e.jsx(be,{props:{}})})]}),e.jsxs(a.Item,{value:"machineerrors",children:[e.jsx(a.Control,{children:e.jsx(C,{size:"lg",children:t._({id:"Y7d3OC"})})}),e.jsx(a.Panel,{children:e.jsxs(b,{gap:"xs",children:[e.jsxs(h,{justify:"space-beteen",wrap:"nowrap",style:{width:"100%"},children:[l?e.jsx(R,{flex:10,color:"red",title:t._({id:"iXdfqc"}),icon:e.jsx(D,{}),children:e.jsx(j,{children:t._({id:"2U2qZc"})})}):e.jsx(R,{flex:10,color:"green",title:t._({id:"32TD49"}),icon:e.jsx(D,{}),children:e.jsx(j,{children:t._({id:"Jb0bCL"})})}),e.jsx(X,{variant:"outline",onClick:()=>d(),children:e.jsx(W,{})})]}),l&&e.jsx(z,{children:(o=n==null?void 0:n.registry_errors)==null?void 0:o.map((s,i)=>e.jsx(z.Item,{children:e.jsx(O,{children:s.message})},i))})]})})]})]})}export{Ye as default};
//# sourceMappingURL=MachineManagementPanel-3CNacGQa.js.map
