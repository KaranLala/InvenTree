{"version":3,"file":"RoleTable-1NBrrrrm.js","sources":["../../../../../../frontend/src/components/items/RoleTable.tsx"],"sourcesContent":["import { ApiEndpoints } from '@lib/enums/ApiEndpoints';\nimport { apiUrl } from '@lib/functions/Api';\nimport { t } from '@lingui/core/macro';\nimport { Trans } from '@lingui/react/macro';\nimport {\n  Button,\n  Checkbox,\n  Group,\n  Stack,\n  Table,\n  Text,\n  Tooltip\n} from '@mantine/core';\nimport { notifications } from '@mantine/notifications';\nimport { IconCircleCheck, IconReload } from '@tabler/icons-react';\nimport { useCallback, useEffect, useMemo, useState } from 'react';\nimport { api } from '../../App';\n\nexport interface RuleSet {\n  pk?: number;\n  group?: number;\n  name: string;\n  label: string;\n  can_view: boolean;\n  can_add: boolean;\n  can_change: boolean;\n  can_delete: boolean;\n  edited?: boolean;\n}\n\nexport function RoleTable({\n  roles,\n  editable = false\n}: {\n  roles: RuleSet[];\n  editable?: boolean;\n}) {\n  const [rulesets, setRulesets] = useState<RuleSet[]>(roles);\n\n  useEffect(() => {\n    setRulesets(roles);\n  }, [roles]);\n\n  const edited = useMemo(() => rulesets.some((r) => r.edited), [rulesets]);\n\n  // Ensure the rulesets are always displayed in the same order\n  const sortedRulesets = useMemo(() => {\n    return rulesets.sort((a, b) => (a.label > b.label ? 1 : -1));\n  }, [rulesets]);\n\n  // Change the edited state of the ruleset\n  const onToggle = useCallback(\n    (rule: RuleSet, field: string) => {\n      if (!editable) {\n        return;\n      }\n      setRulesets((prev) => {\n        const updated = prev.map((r) => {\n          if (r.pk === rule.pk) {\n            return {\n              ...r,\n              [field]: !(r as any)[field],\n              edited: true\n            };\n          }\n          return r;\n        });\n        return updated;\n      });\n    },\n    [editable]\n  );\n\n  const onSave = async (rulesets: RuleSet[]) => {\n    if (!editable) {\n      return;\n    }\n\n    notifications.show({\n      id: 'group-roles-update',\n      title: t`Updating`,\n      message: t`Updating group roles`,\n      loading: true,\n      color: 'blue',\n      autoClose: false\n    });\n\n    for (const ruleset of rulesets.filter((r) => r.edited)) {\n      await api\n        .patch(apiUrl(ApiEndpoints.ruleset_list, ruleset.pk), {\n          can_view: ruleset.can_view,\n          can_add: ruleset.can_add,\n          can_change: ruleset.can_change,\n          can_delete: ruleset.can_delete\n        })\n        .then(() => {\n          // Mark this ruleset as \"not edited\"\n          setRulesets((prev) => {\n            const updated = prev.map((r) => {\n              if (r.pk === ruleset.pk) {\n                return {\n                  ...r,\n                  edited: false\n                };\n              }\n              return r;\n            });\n            return updated;\n          });\n        })\n        .catch((error) => {\n          console.error(error);\n        });\n    }\n\n    notifications.update({\n      id: 'group-roles-update',\n      title: t`Updated`,\n      message: t`Group roles updated`,\n      autoClose: 2000,\n      color: 'green',\n      icon: <IconCircleCheck />,\n      loading: false\n    });\n  };\n\n  return (\n    <>\n      <Stack gap='xs'>\n        <Table striped withColumnBorders withRowBorders withTableBorder>\n          <Table.Thead>\n            <Table.Tr>\n              <Table.Th>\n                <Text fw={700}>\n                  <Trans>Role</Trans>\n                </Text>\n              </Table.Th>\n              <Table.Th>\n                <Text fw={700}>\n                  <Trans>View</Trans>\n                </Text>\n              </Table.Th>\n              <Table.Th>\n                <Text fw={700}>\n                  <Trans>Change</Trans>\n                </Text>\n              </Table.Th>\n              <Table.Th>\n                <Text fw={700}>\n                  <Trans>Add</Trans>\n                </Text>\n              </Table.Th>\n              <Table.Th>\n                <Text fw={700}>\n                  <Trans>Delete</Trans>\n                </Text>\n              </Table.Th>\n            </Table.Tr>\n          </Table.Thead>\n          <Table.Tbody>\n            {sortedRulesets.map((rule) => (\n              <Table.Tr key={rule.pk ?? rule.name}>\n                <Table.Td>\n                  <Group gap='xs'>\n                    <Text>{rule.label}</Text>\n                    {rule.edited && <Text>*</Text>}\n                  </Group>\n                </Table.Td>\n                <Table.Td>\n                  <Checkbox\n                    disabled={!editable}\n                    checked={rule.can_view}\n                    onChange={() => onToggle(rule, 'can_view')}\n                  />\n                </Table.Td>\n                <Table.Td>\n                  <Checkbox\n                    disabled={!editable}\n                    checked={rule.can_change}\n                    onChange={() => onToggle(rule, 'can_change')}\n                  />\n                </Table.Td>\n                <Table.Td>\n                  <Checkbox\n                    disabled={!editable}\n                    checked={rule.can_add}\n                    onChange={() => onToggle(rule, 'can_add')}\n                  />\n                </Table.Td>\n                <Table.Td>\n                  <Checkbox\n                    disabled={!editable}\n                    checked={rule.can_delete}\n                    onChange={() => onToggle(rule, 'can_delete')}\n                  />\n                </Table.Td>\n              </Table.Tr>\n            ))}\n          </Table.Tbody>\n        </Table>\n        {editable && (\n          <Group justify='right'>\n            <Tooltip label={t`Reset group roles`} disabled={!edited}>\n              <Button\n                color='red'\n                onClick={() => {\n                  setRulesets(roles);\n                }}\n                disabled={!edited}\n                leftSection={<IconReload />}\n              >\n                {t`Reset`}\n              </Button>\n            </Tooltip>\n            <Tooltip label={t`Save group roles`} disabled={!edited}>\n              <Button\n                color='green'\n                onClick={() => {\n                  onSave(rulesets);\n                }}\n                disabled={!edited}\n                leftSection={<IconCircleCheck />}\n              >\n                {t`Save`}\n              </Button>\n            </Tooltip>\n          </Group>\n        )}\n      </Stack>\n    </>\n  );\n}\n"],"names":["RoleTable","roles","editable","rulesets","setRulesets","useState","useEffect","edited","useMemo","some","r","sortedRulesets","sort","a","b","label","onToggle","useCallback","rule","field","prev","map","pk","onSave","notifications","show","id","title","_i18n","_","message","loading","color","autoClose","ruleset","filter","api","patch","apiUrl","ApiEndpoints","ruleset_list","can_view","can_add","can_change","can_delete","then","catch","error","console","update","icon","IconCircleCheck","jsx","Fragment","jsxs","Stack","Table","Text","_Trans","Group","Checkbox","name","Tooltip","Button","IconReload"],"mappings":"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"}
