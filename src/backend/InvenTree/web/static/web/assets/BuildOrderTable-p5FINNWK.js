import{r as n,i as a,j as t,bU as k,ei as y,S as v,bx as B,bP as I,bQ as p,aC as M,ap as O,aG as V,aL as T,b4 as U,ah as w,bw as P}from"./vendor-c9tu_e1b.js";import{b as F,z as Q,S as g,B as G,h as N,q as $,A as W}from"./UseForm-21BEg7Md.js";import{P as R}from"./index-D1sX3jYA.js";import{e as j,A as h,f as D,m as b,b as X,U as z}from"./index-C-YqHYR0.js";import{R as A}from"./RemoveRowButton-0iZczeVG.js";import{a as H,u as q}from"./UseGenerator-DwBNXut7.js";import{P as S,R as J,S as Y,b as K,B as Z,c as ee,e as te,T as ae,k as ie,g as se}from"./ColumnRenderers-6-W27ey5.js";import{u as le,c as re,b as ne,d as oe,A as de,M as ue,e as ce,C as _e,f as me,T as fe,g as pe,S as xe,h as he,i as be,j as ye,k as je,H as Fe,J as ge,l as ke,F as Se,n as Ce,I as ve}from"./InvenTreeTable-_nPJoCLK.js";function Te({create:e,modalId:i}){const[o,l]=n.useState(null),[u,_]=n.useState(""),s=q({modalId:i,onGenerate:c=>{_(m=>m||c)}}),d=D();return n.useMemo(()=>{const c={reference:{},part:{disabled:!e,filters:{assembly:!0,virtual:!1,active:d.isSet("BUILDORDER_REQUIRE_ACTIVE_PART")?!0:void 0,locked:d.isSet("BUILDORDER_REQUIRE_LOCKED_PART")?!0:void 0},onValueChange(m,f){f&&l(f.default_location||f.category_default_location),s.update({part:m})}},title:{},quantity:{},project_code:{icon:t.jsx(P,{})},priority:{},parent:{icon:t.jsx(w,{}),filters:{part_detail:!0}},sales_order:{icon:t.jsx(U,{})},batch:{placeholder:s.result&&`${a._({id:"iAY2dt"})}: ${s.result}`,value:u,onValueChange:m=>_(m)},start_date:{icon:t.jsx(T,{})},target_date:{icon:t.jsx(T,{})},take_from:{},destination:{filters:{structural:!1},value:o},link:{icon:t.jsx(V,{})},issued_by:{icon:t.jsx(O,{}),filters:{is_active:!0}},responsible:{icon:t.jsx(M,{}),filters:{is_active:!0}},external:{}};return d.isSet("PROJECT_CODES_ENABLED",!0)||delete c.project_code,d.isSet("BUILDORDER_EXTERNAL_BUILDS",!0)||delete c.external,c},[e,o,u,s.result,d])}function Oe({build:e,modalId:i}){var m,f;const o=n.useMemo(()=>{var r;return((r=e.part_detail)==null?void 0:r.trackable)??!1},[e.part_detail]),[l,u]=n.useState(null);n.useEffect(()=>{var r;u(e.location||((r=e.part_detail)==null?void 0:r.default_location)||null)},[e.location,e.part_detail]);const[_,s]=n.useState(0);n.useEffect(()=>{const r=e.quantity??0,x=e.completed??0;s(Math.max(0,r-x))},[e]);const d=H({modalId:i,initialQuery:{part:e.part||((m=e.part_detail)==null?void 0:m.pk)}}),c=q({modalId:i,initialQuery:{part:e.part||((f=e.part_detail)==null?void 0:f.pk),quantity:e.quantity}});return n.useMemo(()=>({quantity:{value:_,onValueChange:r=>{s(r)}},serial_numbers:{hidden:!o,placeholder:d.result&&`${a._({id:"TVYdHj"})}: ${d.result}`},batch_code:{placeholder:c.result&&`${a._({id:"iAY2dt"})}: ${c.result}`},location:{value:l,onValueChange:r=>{s(r)}},auto_allocate:{hidden:!o}}),[_,c.result,d.result,o])}function C({props:e,record:i}){const o=n.useMemo(()=>i.serial?`# ${i.serial}`:`${a._({id:"VbWX2u"})}: ${i.quantity}`,[i]);return t.jsx(t.Fragment,{children:t.jsxs(p.Tr,{children:[t.jsx(p.Td,{children:t.jsx(S,{part:i.part_detail})}),t.jsx(p.Td,{children:t.jsx(G,{props:e,errorKey:"output",children:o})}),t.jsx(p.Td,{children:i.batch}),t.jsxs(p.Td,{children:[t.jsx(N,{status:i.status,type:b.stockitem})," "]}),t.jsx(p.Td,{style:{width:"1%",whiteSpace:"nowrap"},children:t.jsx(A,{onClick:()=>e.removeFn(e.idx)})})]})})}function Ve({build:e,outputs:i,onFormSuccess:o}){const[l,u]=n.useState(null);n.useEffect(()=>{var s;l||u(e.destination||((s=e.part_detail)==null?void 0:s.default_location)||null)},[l,e.destination,e.part_detail]);const _=n.useMemo(()=>({outputs:{field_type:"table",value:i.map(s=>({output:s.pk})),modelRenderer:s=>{const d=i.find(c=>c.pk==s.item.output);return t.jsx(C,{props:s,record:d},d.pk)},headers:[{title:a._({id:"vgP+9p"})},{title:a._({id:"gILim+"})},{title:a._({id:"rsx3xA"})},{title:a._({id:"uAQUqI"})},{title:"",style:{width:"50px"}}]},status_custom_key:{},location:{filters:{structural:!1},value:l,onValueChange:s=>{u(s)}},notes:{},accept_incomplete_allocation:{}}),[l,i]);return F({url:j(h.build_output_complete,e.pk),method:"POST",title:a._({id:"0iR9fu"}),fields:_,onFormSuccess:o,successMessage:a._({id:"N3avUJ"}),size:"80%"})}function Ue({build:e,outputs:i,onFormSuccess:o}){const[l,u]=n.useState(null);n.useEffect(()=>{var s;l||u(e.destination||((s=e.part_detail)==null?void 0:s.default_location)||null)},[l,e.destination,e.part_detail]);const _=n.useMemo(()=>({outputs:{field_type:"table",value:i.map(s=>({output:s.pk,quantity:s.quantity})),modelRenderer:s=>{const d=i.find(c=>c.pk==s.item.output);return t.jsx(C,{props:s,record:d},d.pk)},headers:[{title:a._({id:"vgP+9p"})},{title:a._({id:"igx8Og"})},{title:a._({id:"rsx3xA"})},{title:a._({id:"uAQUqI"})},{title:"",style:{width:"50px"}}]},location:{value:l,onValueChange:s=>{u(s)}},notes:{},discard_allocations:{}}),[l,i]);return F({url:j(h.build_output_scrap,e.pk),method:"POST",title:a._({id:"69qbY/"}),preFormContent:t.jsx(k,{title:a._({id:"69qbY/"}),color:"yellow",children:t.jsxs(y,{children:[t.jsx(y.Item,{children:a._({id:"zHVfrv"})}),t.jsx(y.Item,{children:a._({id:"SUX6xX"})})]})}),fields:_,onFormSuccess:o,successMessage:a._({id:"C+tSd4"}),size:"80%"})}function we({build:e,outputs:i,onFormSuccess:o}){const l=n.useMemo(()=>({outputs:{field_type:"table",value:i.map(u=>({output:u.pk})),modelRenderer:u=>{const _=i.find(s=>s.pk==u.item.output);return t.jsx(C,{props:u,record:_},_.pk)},headers:[{title:a._({id:"vgP+9p"})},{title:a._({id:"igx8Og"})},{title:a._({id:"rsx3xA"})},{title:a._({id:"uAQUqI"})},{title:"",style:{width:"50px"}}]}}),[i]);return F({url:j(h.build_output_delete,e.pk),method:"POST",title:a._({id:"xS5DxW"}),preFormContent:t.jsx(k,{title:a._({id:"xS5DxW"}),color:"yellow",children:t.jsxs(y,{children:[t.jsx(y.Item,{children:a._({id:"yFxIv1"})}),t.jsx(y.Item,{children:a._({id:"SSAZQG"})})]})}),fields:l,onFormSuccess:o,successMessage:a._({id:"cdFWk4"}),size:"80%"})}function Re({props:e,output:i,record:o,sourceLocation:l}){var s,d,c,m;const u=n.useMemo(()=>({field_type:"related field",api_url:j(h.stock_item_list),model:b.stockitem,autoFill:!!(i!=null&&i.serial),autoFillFilters:{serial:i==null?void 0:i.serial},filters:{available:!0,part_detail:!0,location_detail:!0,bom_item:o.bom_item,location:l,cascade:l?!0:void 0},value:e.item.stock_item,name:"stock_item",onValueChange:(f,r)=>{if(e.changeFn(e.idx,"stock_item",f),r){const x=r.quantity-r.allocated;x<e.item.quantity&&e.changeFn(e.idx,"quantity",Math.min(e.item.quantity,x))}}}),[o,e]),_=n.useMemo(()=>({field_type:"number",name:"quantity",required:!0,value:e.item.quantity,onValueChange:f=>{e.changeFn(e.idx,"quantity",f)}}),[e]);return t.jsxs(p.Tr,{children:[t.jsx(p.Td,{children:t.jsx(S,{part:o.part_detail})}),t.jsx(p.Td,{children:t.jsx(R,{value:o.allocatedQuantity,maximum:o.requiredQuantity,progressLabel:!0})}),t.jsx(p.Td,{children:t.jsx(g,{fieldName:"stock_item",fieldDefinition:u,error:(d=(s=e.rowErrors)==null?void 0:s.stock_item)==null?void 0:d.message})}),t.jsx(p.Td,{children:t.jsx(g,{fieldName:"quantity",fieldDefinition:_,error:(m=(c=e.rowErrors)==null?void 0:c.quantity)==null?void 0:m.message})}),t.jsx(p.Td,{children:t.jsx(A,{onClick:()=>e.removeFn(e.idx)})})]},`table-row-${o.pk}`)}function Pe({buildId:e,output:i,outputId:o,build:l,lineItems:u,onFormSuccess:_}){const[s,d]=n.useState(void 0),c=n.useMemo(()=>({items:{field_type:"table",value:[],headers:[{title:a._({id:"vgP+9p"}),style:{minWidth:"175px"}},{title:a._({id:"A/ybx7"}),style:{minWidth:"175px"}},{title:a._({id:"igx8Og"}),style:{width:"100%"}},{title:a._({id:"VbWX2u"}),style:{minWidth:"175px"}},{title:"",style:{width:"50px"}}],modelRenderer:x=>{const E=u.find(L=>L.pk==x.item.build_line)??{};return t.jsx(Re,{output:i,props:x,record:E,sourceLocation:s},x.idx)}}}),[i,u,s]);n.useEffect(()=>{d(l==null?void 0:l.take_from)},[l==null?void 0:l.take_from]);const m=n.useMemo(()=>({field_type:"related field",api_url:j(h.stock_location_list),model:b.stocklocation,required:!1,label:a._({id:"/00Ond"}),description:a._({id:"IArqwk"}),name:"source_location",value:l==null?void 0:l.take_from,onValueChange:r=>{d(r)}}),[l==null?void 0:l.take_from]),f=n.useMemo(()=>t.jsxs(v,{gap:"xs",children:[(i==null?void 0:i.pk)&&t.jsxs(v,{gap:"xs",children:[t.jsx(k,{color:"blue",icon:t.jsx(B,{}),title:a._({id:"gILim+"}),children:t.jsx(Q,{instance:i})}),t.jsx(I,{})]}),t.jsx(g,{fieldDefinition:m})]}),[i,m]);return F({url:h.build_order_allocate,pk:e,title:a._({id:"L1LMmH"}),fields:c,preFormContent:f,successMessage:a._({id:"23SrHL"}),onFormSuccess:_,initialData:{items:u.map(r=>({build_line:r.pk,stock_item:void 0,quantity:Math.max(0,r.requiredQuantity-r.allocatedQuantity),output:o}))},size:"80%"})}function Qe({partId:e,parentBuildId:i,salesOrderId:o}){const l=D(),u=le(e?"buildorder-part":"buildorder-index"),_=n.useMemo(()=>[J({}),{accessor:"part",sortable:!0,switchable:!1,render:r=>S({part:r.part_detail})},{accessor:"part_detail.IPN",sortable:!0,switchable:!0,title:a._({id:"3wXEsN"})},{accessor:"part_detail.revision",title:a._({id:"6LTyxl"}),sortable:!0,defaultVisible:!1},{accessor:"title",sortable:!1},{accessor:"completed",sortable:!0,switchable:!1,render:r=>t.jsx(R,{progressLabel:!0,value:r.completed,maximum:r.quantity})},Y({model:b.build}),K({defaultVisible:!1}),{accessor:"level",sortable:!0,switchable:!0,hidden:!i,defaultVisible:!1},{accessor:"priority",sortable:!0,defaultVisible:!1},Z({accessor:"external",title:a._({id:"bVhrVt"}),sortable:!0,switchable:!0,hidden:!l.isSet("BUILDORDER_EXTERNAL_BUILDS")}),ee({defaultVisible:!1}),te({defaultVisible:!1}),ae({}),ie({accessor:"completion_date",title:a._({id:"41ha49"}),sortable:!0}),{accessor:"issued_by",sortable:!0,render:r=>t.jsx($,{instance:r==null?void 0:r.issued_by_detail})},se({})],[i,l]),s=n.useMemo(()=>{const r=[re(),ne({model:b.build}),oe(),de(),ue(),ce(),_e(),me(),fe(),pe(),xe(),he(),{name:"has_target_date",type:"boolean",label:a._({id:"egtJvp"}),description:a._({id:"hnmJUh"})},{name:"has_start_date",type:"boolean",label:a._({id:"7Cajbj"}),description:a._({id:"dklbxT"})},be(),ye(),je(),Fe(),ge(),ke(),{name:"external",label:a._({id:"bVhrVt"}),description:a._({id:"tJZ0bI"}),active:l.isSet("BUILDORDER_EXTERNAL_BUILDS")},Se()];return e&&r.push(Ce()),r},[e,l]),d=X(),c=Te({create:!0,modalId:"create-build-order"}),m=F({url:h.build_order_list,title:a._({id:"59jtLx"}),modalId:"create-build-order",fields:c,initialData:{part:e,sales_order:o,parent:i},follow:!0,modelType:b.build}),f=n.useMemo(()=>[t.jsx(W,{hidden:!d.hasAddRole(z.build),tooltip:a._({id:"59jtLx"}),onClick:()=>m.open()},"add-build-order")],[d]);return t.jsxs(t.Fragment,{children:[m.modal,t.jsx(ve,{url:j(h.build_order_list),tableState:u,columns:_,props:{params:{part:e,ancestor:i,sales_order:o,part_detail:!0},tableActions:f,tableFilters:s,modelType:b.build,enableSelection:!0,enableReports:!0,enableDownload:!0}})]})}export{Qe as B,Pe as a,Oe as b,Ve as c,Ue as d,we as e,Te as u};
//# sourceMappingURL=BuildOrderTable-p5FINNWK.js.map
